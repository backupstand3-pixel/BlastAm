import { S as Script, V as Vec3, m as math, a as Vec2, c as createScript } from './index.mjs';

const managers=new WeakMap;function createJoyPadManager(app){const clickedThresholdMs=200;const prevButtonStates={};const buttonStates={};app.on("update",()=>{for(let key of Object.keys(buttonStates)){const val=buttonStates[key];prevButtonStates[key]=val;}});const touchJoypad={buttons:{isPressed:function(name){const state=buttonStates[name];return !!state},wasPressed:function(name){const state=buttonStates[name];const prev=prevButtonStates[name];if(buttonStates[name]!==undefined){return !prev&&state}return false},wasReleased:function(name){const state=buttonStates[name];const prev=prevButtonStates[name];if(buttonStates[name]!==undefined){return prev&&!state}return false},wasTapped:function(name){if(this.wasReleased(name)){const now=Date.now();return now-prevButtonStates[name]<=clickedThresholdMs}return false}},sticks:{}};return {buttonStates,touchJoypad}}const getTouchJoyPadManager$1=app=>{if(!managers.has(app)){managers.set(app,createJoyPadManager(app));}return managers.get(app)};

var touchJoypadLibrary = /*#__PURE__*/Object.freeze({
    __proto__: null,
    getTouchJoyPadManager: getTouchJoyPadManager$1
});

function _define_property$1(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}const JoystickTypeEnum={FIXED:"fixed",RELATIVE:"relative",DRAG:"drag"};class TouchJoystick extends Script{initialize(){const{touchJoypad,buttonStates}=getTouchJoyPadManager$1(this.app);this.touchJoypad=touchJoypad;this.buttonStates=buttonStates;if(this.touchJoypad.sticks[this.identifier]!==undefined){console.warn("Touch joystick identifier already used, please use another for Entity: "+this.entity.name);return}this._originalLocalPosition=this.baseEntity.getLocalPosition().clone();this._lastPointerDownPosition=new Vec3;this._setAxisValues(0,0);this._inputDown=false;this._pointerId=-1;this._canVibrate=!!navigator.vibrate;this._setButtonState(false);this.on("state",state=>{this._setEvents(state?"on":"off");});this.on("destroy",()=>{this.touchJoypad.sticks[this.identifier]=undefined;});this._setEvents("on");}_setEvents(offOn){this._setAxisValues(0,0);this._pointerDown=false;this._pointerId=-1;this.baseEntity.enabled=!this.hideOnRelease;this.entity.element[offOn]("mousedown",this._onMouseDown,this);this.entity.element[offOn]("mousemove",this._onMouseMove,this);this.entity.element[offOn]("mouseup",this._onMouseUp,this);if(this.app.touch){this.entity.element[offOn]("touchstart",this._onTouchDown,this);this.entity.element[offOn]("touchmove",this._onTouchMove,this);this.entity.element[offOn]("touchend",this._onTouchUp,this);this.entity.element[offOn]("touchcancel",this._onTouchUp,this);}}screenToUi(screenPosition){const uiPos=TouchJoystick.__uiPos;const canvasWidth=this.app.graphicsDevice.canvas.clientWidth;const canvasHeight=this.app.graphicsDevice.canvas.clientHeight;uiPos.x=screenPosition.x/canvasWidth;uiPos.y=screenPosition.y/canvasHeight;uiPos.mulScalar(2).subScalar(1);uiPos.y*=-1;return uiPos}_onPointerDown(pointer){const uiPos=this.screenToUi(pointer);switch(this.type){case"drag":case"relative":this.baseEntity.setPosition(uiPos.x,uiPos.y,0);this.nubEntity.setLocalPosition(0,0,0);this._pointerDown=true;break;case"fixed":this.nubEntity.setPosition(uiPos.x,uiPos.y,0);this._updateAxisValuesFromNub();this._pointerDown=true;break}if(this._pointerDown){if(this._canVibrate&&this.vibrationPress!==0){navigator.vibrate(this.vibrationPress);}this._pointerId=pointer.id?pointer.id:0;this._setButtonState(true);this._lastPointerDownPosition.copy(this.baseEntity.getLocalPosition());this.baseEntity.enabled=true;this._onPointerMove(pointer);}}_onPointerMove(pointer){if(this._pointerDown&&this._pointerId===pointer.id){const uiPos=this.screenToUi(pointer);const axisRangeSq=this.axisRange*this.axisRange;this.nubEntity.setPosition(uiPos.x,uiPos.y,0);const nubPos=TouchJoystick.__tempNubPos;nubPos.copy(this.nubEntity.getLocalPosition());const nubLengthSq=nubPos.lengthSq();if(nubLengthSq>=axisRangeSq){if(this.type==="drag"){const distanceDiff=nubPos.length()-this.axisRange;const basePos=TouchJoystick.__tempBasePos;basePos.copy(nubPos);basePos.normalize().mulScalar(distanceDiff);basePos.add(this.baseEntity.getLocalPosition());this.baseEntity.setLocalPosition(basePos);}nubPos.normalize().mulScalar(this.axisRange);this.nubEntity.setLocalPosition(nubPos);}this._updateAxisValuesFromNub();}}_onPointerUp(pointer){if(this._pointerDown&&this._pointerId===pointer.id){this.nubEntity.setLocalPosition(0,0,0);if(this.hideOnRelease){this.baseEntity.enabled=false;}switch(this.positionOnRelease){case"original":this.baseEntity.setLocalPosition(this._originalLocalPosition);break;case"lastStart":this.baseEntity.setLocalPosition(this._lastPointerDownPosition);break}this._pointerId=-1;this._updateAxisValuesFromNub();this._setButtonState(false);this._pointerDown=false;}}_updateAxisValuesFromNub(){const axisRange=this.axisRange-this.axisDeadZone;const nubPos=this.nubEntity.getLocalPosition();const signX=Math.sign(nubPos.x);const signY=Math.sign(nubPos.y);const axisX=math.clamp(Math.abs(nubPos.x)-this.axisDeadZone,0,axisRange)*signX;const axisY=math.clamp(Math.abs(nubPos.y)-this.axisDeadZone,0,axisRange)*signY;this._setAxisValues(axisX/axisRange,axisY/axisRange);}_setAxisValues(x,y){if(this.touchJoypad){this.touchJoypad.sticks[this.identifier]={x,y};}this.axisX=x;this.axisY=y;}_setButtonState(state){this.buttonStates[this.identifier]=state?Date.now():null;this._state=state;}constructor(...args){super(...args);_define_property$1(this,"identifier","joystick0");_define_property$1(this,"type",JoystickTypeEnum.FIXED);_define_property$1(this,"baseEntity",void 0);_define_property$1(this,"nubEntity",void 0);_define_property$1(this,"axisDeadZone",10);_define_property$1(this,"axisRange",50);_define_property$1(this,"hideOnRelease",false);_define_property$1(this,"positionOnRelease","stay");_define_property$1(this,"vibrationPress",0);_define_property$1(this,"_onMouseDown",e=>{e.id=0;this._onPointerDown(e);if(this._pointerDown){e.stopPropagation();}});_define_property$1(this,"_onMouseMove",e=>{e.id=0;this._onPointerMove(e);if(this._pointerDown){e.stopPropagation();}});_define_property$1(this,"_onMouseUp",e=>{e.id=0;if(this._pointerDown){e.stopPropagation();}this._onPointerUp(e);});_define_property$1(this,"_onTouchDown",e=>{if(this._pointerDown)return;const wasPointerDown=this._pointerDown;e.id=e.touch.identifier;this._onPointerDown(e);if(!wasPointerDown&&this._pointerDown){e.stopPropagation();}});_define_property$1(this,"_onTouchMove",e=>{e.id=e.touch.identifier;this._onPointerMove(e);if(this._pointerDown){e.stopPropagation();}e.event.preventDefault();});_define_property$1(this,"_onTouchUp",e=>{if(this._pointerDown){e.id=e.touch.identifier;this._onPointerUp(e);e.stopPropagation();}e.event.preventDefault();});}}_define_property$1(TouchJoystick,"__uiPos",new Vec2);_define_property$1(TouchJoystick,"__tempNubPos",new Vec3);_define_property$1(TouchJoystick,"__tempBasePos",new Vec3);

var touchJoystick = /*#__PURE__*/Object.freeze({
    __proto__: null,
    TouchJoystick: TouchJoystick
});

function _define_property(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class TouchButton extends Script{initialize(){this.touchJoypad=getTouchJoyPadManager$1(this.app);if(this.touchJoypad.buttonStates[this.identifier]!==undefined){console.warn(`Touch button identifier already used, please use another for Entity: ${this.entity.name}`);return}this._canVibrate=!!navigator.vibrate;this._state=false;this._setState(false);this.on("state",state=>{this._setEvents(state?"on":"off");});this.on("destroy",()=>{this.touchJoypad.buttonStates[this.identifier]=undefined;});this._setEvents("on");}_setEvents(mode){this._state=false;const el=this.entity.element;if(!el)return;el[mode]("mousedown",this._onMouseDown,this);el[mode]("mouseup",this._onMouseUp,this);if(this.app.touch){el[mode]("touchstart",this._onTouchDown,this);el[mode]("touchend",this._onTouchUp,this);el[mode]("touchcancel",this._onTouchUp,this);}}_onMouseDown(e){if(!this._state){this._onPointerDown();e.stopPropagation();}}_onMouseUp(e){if(this._state){this._onPointerUp();e.stopPropagation();}}_onTouchDown(e){if(!this._state){this._onPointerDown();e.stopPropagation();}}_onTouchUp(e){if(this._state){this._onPointerUp();e.stopPropagation();}if(e.event?.preventDefault){e.event.preventDefault();}}_onPointerDown(){if(this._canVibrate&&this.vibration>0){navigator.vibrate(this.vibration);}this._setState(true);}_onPointerUp(){this._setState(false);}_setState(state){this.touchJoypad.buttonStates[this.identifier]=state?Date.now():null;this._state=state;}constructor(...args){super(...args);_define_property(this,"identifier","button0");_define_property(this,"vibration",0);}}

var touchButton = /*#__PURE__*/Object.freeze({
    __proto__: null,
    TouchButton: TouchButton
});

var PlayerController=createScript("playerController");PlayerController.attributes.add("speed",{type:"number",default:5,title:"Move Speed"});PlayerController.attributes.add("joystickId",{type:"string",default:"joystick0",title:"Joystick ID"});PlayerController.prototype.initialize=function(){this.touchJoypad=this.getTouchJoypad();this.rigidbody=this.entity.rigidbody;};PlayerController.prototype.update=function(dt){if(!this.touchJoypad||!this.rigidbody)return;const stick=this.touchJoypad.sticks[this.joystickId];if(!stick)return;const moveX=stick.x*this.speed;const moveZ=stick.y*this.speed;const velocity=new Vec3(moveX,0,moveZ);this.rigidbody.linearVelocity=velocity;if(moveX!==0||moveZ!==0){const angle=Math.atan2(moveX,moveZ);this.entity.setEulerAngles(0,angle*math.RAD_TO_DEG,0);}};PlayerController.prototype.getTouchJoypad=function(){if(typeof getTouchJoyPadManager==="function"){return getTouchJoyPadManager(this.app).touchJoypad}console.warn("TouchJoypad library not loaded!");return null};

var playerController = /*#__PURE__*/Object.freeze({
    __proto__: null
});

export { touchJoystick as a, touchButton as b, playerController as p, touchJoypadLibrary as t };
